<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack Game</title>
<link rel="stylesheet" href="styles/style.css">

<script>
// global variables
const suits = ["spades", "hearts", "diamonds", "clubs"];
const ranks = ["A",2,3,4,5,6,7,8,9,10,"J","Q","K"];
var deck = []; 

// hands and game state
var playerHand = [];
var dealerHand = [];
var gameOver = false;

// Validate username
function validateUserName(username) {
    return new Promise(function(resolve, reject) {
        if(!username.trim()) {
            reject("User name cannot be blank.");
            return;
        }
        var regex = /^[a-zA-Z]+$/;
        if(!regex.test(username)) {
            reject("User name can only contain alpha characters.");
            return;
        }
        resolve(username);
    });
}

// Create full deck
function createDeck() {
    deck = [];
    for (let suit = 0; suit < suits.length; suit++) {
        for (let rank = 0; rank < ranks.length; rank++) {
            deck.push(new Card(suit, rank));
        }
    }
}

// Card constructor
function Card(suit, rank) {
    this.suit = suits[suit];
    this.rank = ranks[rank];
    this.isVisible = true; // visibility on table
    this.dealt = false;    // used to track if drawn
    this.image = this.constructCardImage();
}

// Card prototype to use actual card images
Card.prototype.constructCardImage = function() {
    var rankStr = "";
    switch(this.rank) {
        case "A": rankStr = "ace"; break;
        case "J": rankStr = "jack"; break;
        case "Q": rankStr = "queen"; break;
        case "K": rankStr = "king"; break;
        default: rankStr = this.rank.toString(); break;
    }
    return "images/" + rankStr + "_of_" + this.suit + ".svg";
};

// Show card: face up or back image if hidden
Card.prototype.show = function() {
    if (this.isVisible) {
        return '<img src="' + this.image + '" height="87" width="100">';
    } else {
        return '<img src="images/back.png" height="87" width="60">';
    }
};

// Hide card
Card.prototype.hide = function() {
    this.isVisible = false;
};

// Shuffle deck using Fisher-Yates
function shuffleDeck() {
    for (var i = deck.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = deck[i];
        deck[i] = deck[j];
        deck[j] = temp;
    }

    // Reset all cards
    for (var i = 0; i < deck.length; i++) {
        deck[i].isVisible = true;
        deck[i].dealt = false;
    }

    resetButtons();
    dealInitialCards(); // deal cards after shuffle
    alert("Deck shuffled and new cards dealt!");
}
    
// Start game
async function startGame() {
    var username = document.userForm.elements[0].value.trim();
    try {
        var validUsername = await validateUserName(username);
        document.getElementById('userForm').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('welcomeMessage').textContent = "Welcome " + validUsername + "!";

        createDeck();
        shuffleDeck();       // shuffle
        dealInitialCards();  // deal initial cards
    } catch (error) {
        alert(error);
    }
}

// draw the next undealt card
function drawCard() {
    for (var i = 0; i < deck.length; i++) {
        if (!deck[i].dealt) {
            deck[i].dealt = true;
            return deck[i];
        }
    }
    alert("No cards left in deck!");
    return null;
}

// calculate the value of a hand
function calculateHandValue(hand) {
    var value = 0;
    var aces = 0;

    hand.forEach(function(card) {
        if (card.rank === "A") {
            aces++;
            value += 11;
        } else if (card.rank === "J" || card.rank === "Q" || card.rank === "K") {
            value += 10;
        } else {
            value += card.rank;
        }
    });

    // adjust aces from 11 to 1 as needed
    while (value > 21 && aces > 0) {
        value -= 10;
        aces--;
    }

    return value;
}

// deal initial cards to player and dealer
function dealInitialCards() {
    playerHand = [];
    dealerHand = [];
    gameOver = false;
    document.getElementById("resultMessage").textContent = "";

    var p1 = drawCard();
    var p2 = drawCard();
    var d1 = drawCard();
    var d2 = drawCard();

    if (!p1 || !p2 || !d1 || !d2) return;

    playerHand.push(p1);
    playerHand.push(p2);

    dealerHand.push(d1);
    d2.hide(); // hide dealer's second card
    dealerHand.push(d2);

    updateUI();

    var playerValue = calculateHandValue(playerHand);
    if (playerValue === 21) {
        dealerHand[1].isVisible = true;
        updateUI();
        determineWinner(true);
    }
}

// update UI to show current hands
function updateUI() {
    var playerDiv = document.getElementById("playerCards");
    var dealerDiv = document.getElementById("dealerCards");

    playerDiv.innerHTML = "";
    dealerDiv.innerHTML = "";

    playerHand.forEach(function(card) {
        playerDiv.innerHTML += card.show();
    });

    dealerHand.forEach(function(card) {
        dealerDiv.innerHTML += card.show();
    });

    var playerValue = calculateHandValue(playerHand);
    if (playerValue > 21) {
        endGame("You busted! Dealer wins.");
    }
}

// player chooses to hit
function hit() {
    if (gameOver) return;

    var card = drawCard();
    if (!card) return;

    playerHand.push(card);
    updateUI();
}

// player chooses to stand; dealer plays
function stand() {
    if (gameOver) return;

    dealerHand[1].isVisible = true; // reveal hidden card

    while (calculateHandValue(dealerHand) < 17) {
        var card = drawCard();
        if (!card) break;
        dealerHand.push(card);
    }

    updateUI();
    determineWinner(false);
}

// determine winner after both player and dealer finish
function determineWinner(fromBlackjack) {
    var playerValue = calculateHandValue(playerHand);
    var dealerValue = calculateHandValue(dealerHand);

    if (fromBlackjack) {
        if (dealerValue === 21) {
            endGame("Both have Blackjack! Push (tie).");
        } else {
            endGame("Blackjack! You win!");
        }
        return;
    }

    if (dealerValue > 21) {
        endGame("Dealer busts! You win!");
    } else if (playerValue > dealerValue) {
        endGame("You win!");
    } else if (dealerValue > playerValue) {
        endGame("Dealer wins.");
    } else {
        endGame("Push (tie).");
    }
}

// end game and disable buttons
function endGame(message) {
    gameOver = true;
    document.getElementById("resultMessage").textContent = message;
    document.getElementById("hitButton").disabled = true;
    document.getElementById("standButton").disabled = true;
}

// reset buttons when new round starts
function resetButtons() {
    document.getElementById("hitButton").disabled = false;
    document.getElementById("standButton").disabled = false;
}

// return to the initial form screen
function returnToForm() {
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("userForm").style.display = "block";
    document.getElementById("playerCards").innerHTML = "";
    document.getElementById("dealerCards").innerHTML = "";
    document.getElementById("resultMessage").textContent = "";
    document.userForm.elements[0].value = "";
}
</script>
</head>
<body>
<div class="game-container">
    <h1>Blackjack Game</h1>
    <form name="userForm" id="userForm" style="display: block;">
        Enter your name: <input type="text"> 
        <input type="button" value="Start Game" onclick="startGame()">
    </form>
</div>

<div id="gameArea" style="display: none;">
    <h2 id="welcomeMessage"></h2>

    <div>
        <h3>Dealer's Cards:</h3>
        <div id="dealerCards" class="cards"></div>
    </div>

    <div>
        <h3>Your Cards:</h3>
        <div id="playerCards" class="cards"></div>
    </div>

    <div id="buttons">
        <button id="hitButton" onclick="hit()">Hit</button>
        <button id="standButton" onclick="stand()">Stand</button>
        <button id="shuffleButton" onclick="shuffleDeck()">Shuffle Deck</button>
    </div>

    <h3 id="resultMessage"></h3>

    <button onclick="returnToForm()">Return to Form</button>
</div>
</body>
</html>
